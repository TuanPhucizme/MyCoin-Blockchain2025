{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Send Transaction</title>

    <!-- Google Fonts - Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <!-- Custom CSS -->
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f8f9fa;
      }
      .navbar-brand {
        font-weight: 600;
      }
      .form-container {
        min-height: calc(100vh - 56px); /* Full height minus navbar height */
      }
      .card {
        border: none;
      }
      .card-title {
        font-weight: 600;
      }
      .input-group-text {
        background-color: #e9ecef;
        border: 1px solid #ced4da;
      }
    </style>

    <link rel="icon" type="image/x-icon" href="/static/favicon.ico" />
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
      <div class="container">
        <a class="navbar-brand text-primary" href="{% url 'home' %}">
          <i class="bi bi-wallet2 me-2"></i>My Wallet
        </a>
      </div>
    </nav>

    <!-- Main Content -->
    <div
      class="container d-flex align-items-center justify-content-center form-container"
    >
      <div class="col-12 col-md-8 col-lg-6 col-xl-5">
        <div class="card shadow-sm rounded-4">
          <div class="card-body p-4 p-sm-5">
            <div class="text-center mb-4">
                <i class="bi bi-send-check-fill text-primary fs-1"></i>
                <h3 class="card-title mt-2">G·ª≠i Coin</h3>
                <p class="text-muted">Chuy·ªÉn t√†i s·∫£n c·ªßa b·∫°n m·ªôt c√°ch an to√†n.</p>
            </div>
            
            <div class="alert alert-success d-flex align-items-center d-none" role="alert" id="msgSuccess">
                <i class="bi bi-check-circle-fill me-2"></i>
                <div>
                    Giao d·ªãch ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng!
                </div>
            </div>

            <form id="transactionForm" method="POST" action="{% url 'send_transaction' %}">
                {% csrf_token %}
              <div class="mb-3">
                <label for="receiver" class="form-label">ƒê·ªãa ch·ªâ ng∆∞·ªùi nh·∫≠n</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-wallet2"></i></span>
                    <input type="text" class="form-control" id="receiver" name="receiver" placeholder="D√°n ƒë·ªãa ch·ªâ v√≠ t·∫°i ƒë√¢y" required />
                </div>
              </div>

              <div class="mb-3">
                <label for="amount" class="form-label">S·ªë l∆∞·ª£ng</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-cash-coin"></i></span>
                    <input type="number" step="0.0001" class="form-control" id="amount" name="amount" placeholder="0.0000" required />
                    <span class="input-group-text">MYC</span>
                </div>
              </div>

              <div class="mb-4">
                <label for="message" class="form-label">L·ªùi nh·∫Øn (tu·ª≥ ch·ªçn)</label>
                <textarea class="form-control" id="message" name="message" rows="2" placeholder="G·ª≠i l·ªùi ch√∫c ƒë·∫øn b·∫°n b√®..."></textarea>
              </div>

              <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg d-flex align-items-center justify-content-center gap-2">
                    <i class="bi bi-send-fill"></i> G·ª≠i Ngay
                </button>
                <a href="{% url 'home' %}" class="btn btn-outline-secondary">Quay l·∫°i Dashboard</a>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <script>
        // Th√™m id="transactionForm" v√†o th·∫ª <form> ƒë·ªÉ ƒëo·∫°n code n√†y ho·∫°t ƒë·ªông
        document.getElementById('transactionForm').addEventListener('submit', function (e) {
            // T·∫°m th·ªùi v√¥ hi·ªáu ho√° vi·ªác g·ª≠i form theo c√°ch truy·ªÅn th·ªëng ƒë·ªÉ x·ª≠ l√Ω JS
            // Trong th·ª±c t·∫ø, b·∫°n c√≥ th·ªÉ mu·ªën g·ª≠i b·∫±ng AJAX ho·∫∑c ƒë·ªÉ form t·ª± g·ª≠i
            // e.preventDefault(); 

            const receiver = document.getElementById('receiver').value;
            const amount = document.getElementById('amount').value;
            const message = document.getElementById('message').value;

            console.log('Receiver:', receiver);
            console.log('Amount:', amount);
            console.log('Message:', message);
            
            // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng (c√≥ th·ªÉ b·ªè e.preventDefault() ·ªü tr√™n n·∫øu b·∫°n mu·ªën form v·∫´n ƒë∆∞·ª£c POST ƒëi)
            document.getElementById('msgSuccess').classList.remove('d-none');
        });

        // ƒêo·∫°n code WebSocket c·ªßa b·∫°n gi·ªØ nguy√™n
        const walletAddress = '{{ wallet.address|default:"none" }}';
        if (walletAddress !== 'none') {
            const socket = new WebSocket(
                'ws://' + window.location.host + '/ws/transactions/' + walletAddress + '/'
            );

            socket.onmessage = function (e) {
                const data = JSON.parse(e.data);
                // C√¢n nh·∫Øc s·ª≠ d·ª•ng m·ªôt th∆∞ vi·ªán th√¥ng b√°o (toast) ƒë·∫πp h∆°n thay v√¨ alert
                alert("üí∞ B·∫°n v·ª´a nh·∫≠n ƒë∆∞·ª£c " + data.amount + " MYC t·ª´ " + data.sender + "!");
            };

            socket.onopen = function (e) {
                console.log("üîó K·∫øt n·ªëi WebSocket th√†nh c√¥ng!");
            };

            socket.onerror = function (e) {
                console.error("üö® L·ªói k·∫øt n·ªëi WebSocket:", e);
            };
        }
    </script>
  </body>
</html>