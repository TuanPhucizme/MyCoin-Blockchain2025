{% load static %}
<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Send Transaction</title>
    <!-- ... (to√†n b·ªô ph·∫ßn <head> c·ªßa b·∫°n gi·ªØ nguy√™n) ... -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <style>
      body { font-family: "Poppins", sans-serif; background-color: #f8f9fa; }
      .navbar-brand { font-weight: 600; }
      .form-container { min-height: calc(100vh - 56px); }
      .card { border: none; }
      .card-title { font-weight: 600; }
      .sender-info { background-color: #eef5ff; border-left: 4px solid #0d6efd; }
    </style>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico" />
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
      <div class="container">
        <a class="navbar-brand text-primary" href="{% url 'home' %}"><i class="bi bi-wallet2 me-2"></i>My Wallet</a>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container d-flex align-items-center justify-content-center form-container">
      <div class="col-12 col-md-8 col-lg-6 col-xl-5">
        <div class="card shadow-sm rounded-4">
          <div class="card-body p-4 p-sm-5">
            <div class="text-center mb-4">
              <i class="bi bi-send-check-fill text-primary fs-1"></i>
              <h3 class="card-title mt-2">G·ª≠i Coin</h3>
              <p class="text-muted">Chuy·ªÉn t√†i s·∫£n c·ªßa b·∫°n m·ªôt c√°ch an to√†n.</p>
            </div>
            
            <!-- HI·ªÇN TH·ªä S·ªê D∆Ø V√ç -->
            {% if wallet %}
            <div class="sender-info p-3 rounded mb-4">
              <div class="d-flex justify-content-between align-items-center">
                <span class="text-muted small">S·ªë d∆∞ c·ªßa b·∫°n</span>
                <strong class="fs-5" id="walletBalance">{{ wallet.balance }} MYC</strong>
              </div>
            </div>
            {% endif %}
            
            <!-- V√πng hi·ªÉn th·ªã l·ªói -->
            <div class="alert alert-danger d-none" role="alert" id="error-alert"></div>

            <form id="transactionForm" method="POST" action="{% url 'send_transaction' %}">
              {% csrf_token %}
              <div class="mb-3">
                <label for="receiver" class="form-label">ƒê·ªãa ch·ªâ ng∆∞·ªùi nh·∫≠n</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-wallet2"></i></span>
                  <input type="text" class="form-control" id="receiver" name="receiver" placeholder="D√°n ƒë·ªãa ch·ªâ v√≠ t·∫°i ƒë√¢y" required />
                </div>
              </div>

              <div class="mb-3">
                <label for="amount" class="form-label">S·ªë l∆∞·ª£ng</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-cash-coin"></i></span>
                  <input type="number" step="any" class="form-control" id="amount" name="amount" placeholder="0.00" required />
                  <span class="input-group-text">MYC</span>
                </div>
              </div>

              <div class="mb-4">
                <label for="message" class="form-label">L·ªùi nh·∫Øn (tu·ª≥ ch·ªçn)</label>
                <textarea class="form-control" id="message" name="message" rows="2" placeholder=""></textarea>
              </div>

              <div class="d-grid gap-2">
                <button type="submit" id="submitButton" class="btn btn-primary btn-lg d-flex align-items-center justify-content-center gap-2">
                  <span id="button-icon"><i class="bi bi-send-fill"></i></span>
                  <span id="button-text">G·ª≠i Ngay</span>
                </button>
                <a href="{% url 'home' %}" class="btn btn-outline-secondary">Quay l·∫°i Dashboard</a>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
      document.addEventListener('DOMContentLoaded', function() {
        
        const form = document.getElementById('transactionForm');
        const errorAlert = document.getElementById('error-alert');
        
        form.addEventListener('submit', function (e) {
            e.preventDefault(); // NgƒÉn form g·ª≠i ƒëi theo c√°ch truy·ªÅn th·ªëng

            const submitButton = document.getElementById('submitButton');
            const buttonText = document.getElementById('button-text');
            const buttonIcon = document.getElementById('button-icon');
            
            // ·∫®n th√¥ng b√°o l·ªói c≈©
            errorAlert.classList.add('d-none');

            // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang x·ª≠ l√Ω
            buttonText.textContent = 'ƒêang x·ª≠ l√Ω...';
            buttonIcon.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>`;
            submitButton.disabled = true;

            const formData = new FormData(form);

            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // N·∫øu th√†nh c√¥ng, chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang bi√™n lai
                    window.location.href = data.redirect_url;
                } else {
                    // N·∫øu c√≥ l·ªói, hi·ªÉn th·ªã l·ªói v√† kh√¥i ph·ª•c n√∫t b·∫•m
                    errorAlert.textContent = data.error;
                    errorAlert.classList.remove('d-none');
                    
                    submitButton.disabled = false;
                    buttonText.textContent = 'G·ª≠i Ngay';
                    buttonIcon.innerHTML = `<i class="bi bi-send-fill"></i>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                errorAlert.textContent = 'ƒê√£ x·∫£y ra l·ªói kh√¥ng mong mu·ªën. Vui l√≤ng th·ª≠ l·∫°i.';
                errorAlert.classList.remove('d-none');
                
                // Kh√¥i ph·ª•c n√∫t b·∫•m khi c√≥ l·ªói m·∫°ng
                buttonText.textContent = 'G·ª≠i Ngay';
                buttonIcon.innerHTML = `<i class="bi bi-send-fill"></i>`;
                submitButton.disabled = false;
            });
        });

        // ƒêo·∫°n code WebSocket c·ªßa b·∫°n gi·ªØ nguy√™n
        const walletAddress = '{{ wallet.address|default:"none" }}';
        if (walletAddress !== 'none') {
            const socket = new WebSocket(
                'ws://' + window.location.host + '/ws/transactions/' + walletAddress + '/'
            );

            socket.onmessage = function (e) {
                const data = JSON.parse(e.data);
                // C√¢n nh·∫Øc s·ª≠ d·ª•ng m·ªôt th∆∞ vi·ªán th√¥ng b√°o (toast) ƒë·∫πp h∆°n thay v√¨ alert
                alert("üí∞ B·∫°n v·ª´a nh·∫≠n ƒë∆∞·ª£c " + data.amount + " MYC t·ª´ " + data.sender + "!");
            };

            socket.onopen = function (e) {
                console.log("üîó K·∫øt n·ªëi WebSocket th√†nh c√¥ng!");
            };

            socket.onerror = function (e) {
                console.error("üö® L·ªói k·∫øt n·ªëi WebSocket:", e);
            };
        }

      });
    </script>
  </body>
</html>