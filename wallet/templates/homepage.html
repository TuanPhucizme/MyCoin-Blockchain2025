<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blockchain Wallet Dashboard</title>

    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico" />

    <!-- Custom CSS -->
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f8f9fa;
      }
      .navbar-brand { font-weight: 600; }
      .card { border: none; transition: transform 0.2s ease-in-out; }
      .card:hover { transform: translateY(-5px); }
      .card-title { font-weight: 600; color: #343a40; }
      .balance-amount { font-size: 2.5rem; font-weight: 700; color: #0d6efd; }
      .wallet-address { font-family: monospace; font-size: 0.9rem; }
      .table-hover tbody tr:hover { background-color: #eef5ff; }
    </style>
  </head>

  <body>
    <!-- TOAST -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100"></div>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
      <div class="container">
        <a class="navbar-brand text-primary" href="#"><i class="bi bi-wallet2 me-2"></i>My Wallet</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link active" href="#">Dashboard</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="container py-5">
      <!-- Wallet Info & Actions -->
      <div class="row g-4 mb-5">
        {% if wallet %}
        <!-- Wallet Balance Card -->
        <div class="col-lg-8">
          <div class="card shadow-sm rounded-4 h-100">
            <div class="card-body p-4 d-flex flex-column justify-content-between">
              <div>
                <h5 class="card-title text-muted mb-2">T·ªïng s·ªë d∆∞</h5>
                <p class="balance-amount"><span id="balanceDisplay">{{ wallet.balance }}</span> <span class="fs-5 text-muted">MYC</span></p>
              </div>
              <div>
                <label for="walletAddressDisplay" class="form-label small text-muted mb-1">ƒê·ªãa ch·ªâ v√≠:</label>
                <div class="input-group">
                  <input type="text" class="form-control wallet-address" id="walletAddressDisplay" value="{{ wallet.address }}" readonly style="background-color: #e9ecef; border-right: none;">
                  <button class="btn btn-outline-secondary" type="button" id="copyButton" data-bs-toggle="tooltip" title="Sao ch√©p ƒë·ªãa ch·ªâ">
                    <i class="bi bi-clipboard"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Actions Card -->
        <div class="col-lg-4">
          <div class="card shadow-sm rounded-4 h-100">
            <div class="card-body p-4 d-flex flex-column justify-content-center align-items-center text-center gap-3">
              <h5 class="card-title mb-3">Th·ª±c hi·ªán giao d·ªãch</h5>
              <a href="{% url 'send_transaction' %}" class="btn btn-primary btn-lg w-100 d-flex align-items-center justify-content-center gap-2">
                <i class="bi bi-send-fill"></i> G·ª≠i Coin
              </a>
            </div>
          </div>
        </div>
        {% else %}
        <!-- No Wallet Card -->
        <div class="col-12">
          <div class="card shadow-sm rounded-4">
            <div class="card-body p-5 text-center">
              <i class="bi bi-exclamation-triangle-fill text-warning fs-1 mb-3"></i>
              <h5 class="card-title">Ch∆∞a c√≥ v√≠ n√†o ƒë∆∞·ª£c ch·ªçn</h5>
              <p class="text-muted">Vui l√≤ng t·∫°o m·ªôt v√≠ m·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu qu·∫£n l√Ω t√†i s·∫£n c·ªßa b·∫°n.</p>
              <a href="{% url 'create_wallet' %}" class="btn btn-primary mt-3">
                <i class="bi bi-plus-circle-fill me-2"></i>T·∫°o v√≠ m·ªõi
              </a>
            </div>
          </div>
        </div>
        {% endif %}
      </div>

      <!-- Transaction History -->
      <div class="card shadow-sm rounded-4">
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title mb-0">L·ªãch s·ª≠ giao d·ªãch</h5>
          </div>
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th scope="col">Lo·∫°i</th>
                  <th scope="col">T·ª´ / ƒê·∫øn</th>
                  <th scope="col" class="text-end">S·ªë l∆∞·ª£ng</th>
                  <th scope="col" class="d-none d-md-table-cell">Th·ªùi gian</th>
                </tr>
              </thead>
              <tbody id="transaction-table-body">
                {% for tx in transactions %}
                <tr>
                  <td>
                    {% if tx.sender == wallet.address %}
                    <span class="badge bg-danger-subtle text-danger-emphasis rounded-pill p-2"><i class="bi bi-arrow-up-right-circle-fill me-1"></i> G·ª≠i</span>
                    {% else %}
                    <span class="badge bg-success-subtle text-success-emphasis rounded-pill p-2"><i class="bi bi-arrow-down-left-circle-fill me-1"></i> Nh·∫≠n</span>
                    {% endif %}
                  </td>
                  <td>
                    <a href="{% url 'transaction_detail' transaction_id=tx.id %}" class="text-decoration-none">
                        <div class="fw-bold text-truncate" style="max-width: 150px;" title="{% if tx.sender == wallet.address %}{{ tx.receiver }}{% else %}{{ tx.sender }}{% endif %}">
                            {% if tx.sender == wallet.address %} {{ tx.receiver|truncatechars:20 }} {% else %} {{ tx.sender|truncatechars:20 }} {% endif %}
                        </div>
                    </a>
                  </td>
                  <td class="text-end fw-bold">{% if tx.sender == wallet.address %} - {% else %} + {% endif %}{{ tx.amount }} MYC</td>
                  <td class="text-muted d-none d-md-table-cell">{{ tx.timestamp|date:"d M, Y H:i" }}</td>
                </tr>
                {% empty %}
                <!-- ƒê√É TH√äM ID V√ÄO ƒê√ÇY -->
                <tr id="no-transactions-row">
                  <td colspan="4" class="text-center text-muted p-4"><i class="bi bi-clock-history d-block fs-2 mb-2"></i>Ch∆∞a c√≥ giao d·ªãch n√†o</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script>
      // Ch·∫°y script sau khi to√†n b·ªô trang ƒë√£ ƒë∆∞·ª£c t·∫£i
      document.addEventListener('DOMContentLoaded', function() {

        // --- KH·ªêI SAO CH√âP ƒê·ªäA CH·ªà V√ç ---
        const copyButton = document.getElementById('copyButton');
        if (copyButton) {
          const tooltip = new bootstrap.Tooltip(copyButton);
          copyButton.addEventListener('click', function() {
            const walletAddressInput = document.getElementById('walletAddressDisplay');
            navigator.clipboard.writeText(walletAddressInput.value).then(() => {
              copyButton.setAttribute('data-bs-original-title', 'ƒê√£ sao ch√©p!');
              tooltip.show();
              copyButton.innerHTML = '<i class="bi bi-check-lg"></i>';
              setTimeout(() => {
                copyButton.setAttribute('data-bs-original-title', 'Sao ch√©p ƒë·ªãa ch·ªâ');
                tooltip.hide();
                copyButton.innerHTML = '<i class="bi bi-clipboard"></i>';
              }, 2000);
            }).catch(err => console.error('L·ªói khi sao ch√©p: ', err));
          });
        }
        
        // --- KH·ªêI WEBSOCKET C·∫¨P NH·∫¨T REAL-TIME ---
        const walletAddress = "{{ wallet.address|default:'' }}";
        if (walletAddress) {
          const socket = new WebSocket(`ws://${window.location.host}/ws/transactions/${walletAddress}/`);

          socket.onopen = function(e) { console.log("‚úÖ K·∫øt n·ªëi WebSocket th√†nh c√¥ng!"); };
          socket.onerror = function(e) { console.error("üö® L·ªói k·∫øt n·ªëi WebSocket:", e); };

          // CH·ªà C√ì M·ªòT H√ÄM socket.onmessage DUY NH·∫§T V√Ä HO√ÄN CH·ªàNH
          socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if (data.type === "wallet_update") {
              
              const transaction = data.transaction;

              // 1. Hi·ªÉn th·ªã toast th√¥ng b√°o
              showTransactionToast(transaction);

              // 2. C·∫≠p nh·∫≠t s·ªë d∆∞
              document.getElementById('balanceDisplay').textContent = data.balance;
              
              // 3. C·∫≠p nh·∫≠t b·∫£ng giao d·ªãch
              const tableBody = document.getElementById('transaction-table-body');
              const noTxRow = document.getElementById('no-transactions-row');
              if (noTxRow) noTxRow.remove();

              const newRow = tableBody.insertRow(0);
              const txTimestamp = new Date(transaction.timestamp).toLocaleString('vi-VN');

              // Logic ƒë·ªÉ x√°c ƒë·ªãnh giao d·ªãch l√† G·ª≠i hay Nh·∫≠n t·ª´ g√≥c nh√¨n c·ªßa ng∆∞·ªùi d√πng hi·ªán t·∫°i
              const isSender = transaction.sender === walletAddress;
              const displayAddress = isSender ? transaction.receiver : transaction.sender;
              
              // T·∫°o HTML cho d√≤ng m·ªõi, BAO G·ªíM C·∫¢ TH·∫∫ <a> v·ªõi href ƒë√∫ng
              newRow.innerHTML = `
                <td>
                  ${isSender 
                      ? `<span class="badge bg-danger-subtle text-danger-emphasis rounded-pill p-2"><i class="bi bi-arrow-up-right-circle-fill me-1"></i> G·ª≠i</span>` 
                      : `<span class="badge bg-success-subtle text-success-emphasis rounded-pill p-2"><i class="bi bi-arrow-down-left-circle-fill me-1"></i> Nh·∫≠n</span>`
                  }
                </td>
                <td>
                  <a href="${transaction.detail_url}" class="text-decoration-none" title="Xem chi ti·∫øt giao d·ªãch">
                      <div class="fw-bold text-truncate" style="max-width: 150px;">
                          ${displayAddress}
                      </div>
                  </a>
                </td>
                <td class="text-end fw-bold">
                  ${isSender ? '-' : '+'} ${transaction.amount} MYC
                </td>
                <td class="text-muted d-none d-md-table-cell">${txTimestamp}</td>
              `;
            }
          };
        }

        // H√ÄM HI·ªÇN TH·ªä TOAST (gi·ªØ nguy√™n, ƒë√£ ƒë√∫ng)
        function showTransactionToast(transaction) {
          const toastContainer = document.querySelector('.toast-container');
          if (!toastContainer) return;
          
          const truncateAddress = (address, startChars = 6, endChars = 4) => {
            if (!address) return '';
            return `${address.substring(0, startChars)}...${address.substring(address.length - endChars)}`;
          };
          
          const toastHTML = `
            <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
              <div class="toast-header">
                <i class="bi bi-bell-fill text-success me-2"></i>
                <strong class="me-auto">Giao d·ªãch m·ªõi</strong>
                <small class="text-muted">v·ª´a xong</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
              </div>
              <div class="toast-body">
                <div>
                  B·∫°n nh·∫≠n ƒë∆∞·ª£c <strong class="text-success">${transaction.amount} MYC</strong>
                  t·ª´ v√≠: <span class="fw-bold d-block text-truncate">${truncateAddress(transaction.sender)}</span>
                </div>
                ${transaction.message ? `<div class="mt-2 pt-2 border-top"><strong>L·ªùi nh·∫Øn:</strong> ${transaction.message}</div>` : ''}
              </div>
            </div>
          `;
          toastContainer.insertAdjacentHTML('beforeend', toastHTML);
          const newToastEl = toastContainer.lastElementChild;
          if (newToastEl) {
            const toast = new bootstrap.Toast(newToastEl, {
              autohide: true,
              delay: 7000
            });
            toast.show();
            newToastEl.addEventListener('hidden.bs.toast', () => { newToastEl.remove(); });
          }
        }
      });
    </script>
  </body>
</html>